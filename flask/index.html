<!DOCTYPE html>
<html>
<head>
    <title>Voice Call</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twilio-client/1.14.0/twilio.min.js"></script>
    <style>
        .container {
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
            font-family: Arial, sans-serif;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        input {
            padding: 10px;
            margin: 10px;
            width: 200px;
            font-size: 16px;
        }
        #status {
            margin: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Make a Voice Call</h1>
        <input type="tel" id="phoneNumber" placeholder="Enter phone number">
        <br>
        <button id="callButton">Make Call</button>
        <button id="hangupButton" disabled>Hang Up</button>
        <div id="status">Ready to make calls</div>
        
        <div id="volumeControls">
            <label for="volumeMeter">Microphone Volume:</label>
            <meter id="volumeMeter" high="0.25" max="1" value="0"></meter>
        </div>
    </div>

    <script>
        let device;
        let call = null;

        // Get Twilio access token from server
        fetch('/token')
            .then(res => res.json())
            .then(data => {
                // Initialize Twilio Device
                device = new Twilio.Device(data.token, {
                    codecPreferences: ['opus', 'pcmu'],
                    fakeLocalDTMF: true,
                    enableRingingState: true
                });

                device.on('ready', function() {
                    updateStatus('Ready to make calls');
                    document.getElementById('callButton').disabled = false;
                });

                device.on('error', function(error) {
                    updateStatus('Error: ' + error.message);
                });

                device.on('connect', function(conn) {
                    call = conn;
                    document.getElementById('callButton').disabled = true;
                    document.getElementById('hangupButton').disabled = false;
                    updateStatus('On call');
                });

                device.on('disconnect', function() {
                    call = null;
                    document.getElementById('callButton').disabled = false;
                    document.getElementById('hangupButton').disabled = true;
                    updateStatus('Call ended');
                });
            });

        // Make a call
        document.getElementById('callButton').onclick = function() {
            let phoneNumber = document.getElementById('phoneNumber').value;
            if (phoneNumber) {
                updateStatus('Calling ' + phoneNumber + '...');
                device.connect({ to: phoneNumber });
            } else {
                updateStatus('Please enter a phone number');
            }
        };

        // Hang up
        document.getElementById('hangupButton').onclick = function() {
            if (call) {
                call.disconnect();
            }
        };

        // Update status display
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        // Volume meter
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const audioContext = new AudioContext();
                    const analyser = audioContext.createAnalyser();
                    const microphone = audioContext.createMediaStreamSource(stream);
                    const javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                    analyser.smoothingTimeConstant = 0.8;
                    analyser.fftSize = 1024;

                    microphone.connect(analyser);
                    analyser.connect(javascriptNode);
                    javascriptNode.connect(audioContext.destination);

                    javascriptNode.onaudioprocess = function() {
                        const array = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(array);
                        let values = 0;

                        const length = array.length;
                        for (let i = 0; i < length; i++) {
                            values += (array[i]);
                        }

                        const average = values / length;
                        document.getElementById('volumeMeter').value = average / 256;
                    }
                })
                .catch(err => console.log('Error accessing microphone:', err));
        }
    </script>
</body>
</html>